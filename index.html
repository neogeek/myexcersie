<!DOCTYPE html>
<html manifest="manifest.appcache">
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Commit to exercise</title>
<link rel="stylesheet" href="/css/styles.css">
<link rel="apple-touch-icon" href="/images/icon.png">
</head>

<body>

<header>
    <h1><a href="/">Commit to exercise</a></h1>
</header>

<div class="sets"></div>

<div class="set-timer-wrapper hidden">
    <span class="number">3</span>
</div>

<script id="sets-template" type="text/x-handlebars-template">
    {{#each sets}}
    <h2>{{title}}</h2>
    <ul class="set">
        {{#each items}}
        <li class="item" data-seconds="{{seconds}}">
            <span class="number">{{number}}</span>
            {{label}}
            {{#if seconds}}
            <span class="info">({{seconds}} seconds)</span>
            {{/if}}
        </li>
        {{/each}}
    </ul>
    {{/each}}
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.4/handlebars.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
<script src="//code.jquery.com/jquery.min.js"></script>
<script>

var template = Handlebars.compile($('#sets-template').html()),
    countdownValue = 3,
    countdownInterval,
    timerValue = 0,
    timerInterval;

$.getJSON('/data/sets.json').done(function (data) {

    $('.sets').html(template({ sets: data }));

});

FastClick.attach(document.body);

function countdown() {

    if (countdownValue) {

        $('.set-timer-wrapper .number').text(countdownValue--);

    } else {

        clearInterval(countdownInterval);

        timerValue = 0;
        timer();
        timerInterval = setInterval(timer, 1000);

    }

}

function timer() {

    if (timerValue <= parseInt($('.sets .set .item.active').data('seconds'), 10)) {

        $('.set-timer-wrapper .number').text(timerValue++);

    } else {

        clearInterval(timerInterval);

        $('.sets .set .item.active').addClass('done').removeClass('active');

        $('.set-timer-wrapper').addClass('hidden');

    }

}

$('.sets').on('click', '.set li', function () {

    var $this = $(this);

    if (parseInt($this.data('seconds'), 10) > 0) {

        $this.addClass('active');

        $('.set-timer-wrapper').removeClass('hidden');

        countdownValue = 3;
        countdown();
        countdownInterval = setInterval(countdown, 1000);

    } else {

        $this.toggleClass('done');

    }

});

</script>

</body>
</html>
